# React 勘测笔记 V - ReactFiberScheduler

:dolphin: [ReactUpdateQueue.js](https://github.com/TAUnionOtto/react-interpretation/blob/master/packages/react-reconciler/src/ReactFiberScheduler.js)

## React.render 调用过程

![React.render 调用过程](./static/scheduler_reactRender_call_stack.png)

- ReactDom.render
- call to :dolphin: [ReactFiberReconciler.updateContainer](https://github.com/TAUnionOtto/react-interpretation/blob/master/packages/react-reconciler/src/ReactFiberReconciler.js#L287)
  - requestCurrentTime
  - computeExpirationForFiber
  - :dolphin: [ReactFiberReconciler.updateContainerAtExpirationTime](https://github.com/TAUnionOtto/react-interpretation/blob/master/packages/react-reconciler/src/ReactFiberReconciler.js#L165)
    - :dolphin: [ReactFiberReconciler.js @function scheduleRootUpdate](https://github.com/TAUnionOtto/react-interpretation/blob/master/packages/react-reconciler/src/ReactFiberReconciler.js#L115)
      - flushPassiveEffects
      - scheduleWork
        - scheduleWorkToRoot
        - requestWork
        - call to renderRoot
          - flushPassiveEffects

## dom event 触发的 setData

![dom event 触发的 setData](./static/scheduler_domEvent_trigger_setState_call_stack.png)

- :dolphin: [ReactDOMEventListener.js @function dispatchInteractiveEvent](https://github.com/TAUnionOtto/react-interpretation/blob/master/packages/react-dom/src/events/ReactDOMEventListener.js#L184)
- call to interactiveUpdates
- call to Component.prototype.setState
  - :dolphin: [ReactFiberClassComponent.js @classComponentUpdater.enqueueSetState](https://github.com/TAUnionOtto/react-interpretation/blob/master/packages/react-reconciler/src/ReactFiberClassComponent.js#L183)
    - requestCurrentTime
    - computeExpirationForFiber
    - flushPassiveEffects
    - scheduleWork
      - scheduleWorkToRoot
      - requestWork
- call to flushPassiveEffects

## setTimeout 触发的 setData

![setTimeout 触发的 setData](./static/scheduler_setTimeout_trigger_setState_call_stack.png)

- call to Component.prototype.setState
  - :dolphin: [ReactFiberClassComponent.js @classComponentUpdater.enqueueSetState](https://github.com/TAUnionOtto/react-interpretation/blob/master/packages/react-reconciler/src/ReactFiberClassComponent.js#L183)
    - requestCurrentTime
    - computeExpirationForFiber
    - flushPassiveEffects
    - scheduleWork
      - scheduleWorkToRoot
      - requestWork
      - call to renderRoot
        - flushPassiveEffects

## 一般情况下的调用过程

单次 `ReactDOM.render` 和 `setState` 调用 Scheduler 的流程大致相同，都是：

```js
   requestCurrentTime -> computeExpirationForFiber
-> flushPassiveEffects
-> scheduleWork -> scheduleWorkToRoot -> requestWork
-> flushPassiveEffects
```
